# CLI Login Flow

This document describes the implementation of the `kyoto login` command, which allows users to authenticate the CLI via GitHub OAuth through the web application.

## Overview

The CLI login flow bridges GitHub OAuth authentication between the CLI and the web application without requiring database changes. It uses an in-memory session store for testing purposes.

## Architecture

### Components

1. **CLI Command** (`apps/cli/src/commands/login.tsx`)
   - Generates a secure state token (64 hex characters)
   - Opens the browser to `/cli/login?state=<token>`
   - Polls `/api/cli/session?state=<token>` for authentication completion
   - Stores the session token in `.kyoto/config.json`

2. **Web Application**
   - **In-Memory Store** (`apps/web/lib/cli-auth-store.ts`)
     - Stores pending CLI sessions in a Map
     - Sessions expire after 5 minutes
     - Automatic cleanup every minute
   
   - **CLI Login Page** (`apps/web/app/cli/login/page.tsx`)
     - Validates state parameter
     - Registers the session via `/api/cli/init`
     - Initiates GitHub OAuth with better-auth
   
   - **OAuth Callback** (`apps/web/app/cli/callback/page.tsx`)
     - Receives GitHub OAuth callback
     - Completes the CLI session with the session token
     - Redirects to success page
   
   - **API Routes**
     - `/api/cli/init` - Registers a CLI session
     - `/api/cli/session` - Polling endpoint for CLI to retrieve token

3. **Session Storage**
   - Session tokens are stored in `.kyoto/config.json` under the `auth` field
   - Includes user information (name, login)

## Flow Diagram

```
┌─────────────┐                                    ┌──────────────┐
│             │  1. Generate state token           │              │
│     CLI     │───────────────────────────────────▶│   Browser    │
│             │  2. Open /cli/login?state=xxx      │              │
└─────────────┘                                    └──────────────┘
       │                                                   │
       │                                                   │ 3. POST /api/cli/init
       │                                                   │    Register session
       │                                                   ▼
       │                                           ┌──────────────┐
       │                                           │              │
       │                                           │   Web App    │
       │                                           │              │
       │                                           └──────────────┘
       │                                                   │
       │                                                   │ 4. Redirect to GitHub OAuth
       │                                                   │
       │                                                   ▼
       │                                           ┌──────────────┐
       │                                           │              │
       │                                           │   GitHub     │
       │                                           │              │
       │                                           └──────────────┘
       │                                                   │
       │                                                   │ 5. OAuth callback
       │                                                   │
       │                                                   ▼
       │                                           ┌──────────────┐
       │ 6. Poll /api/cli/session?state=xxx        │              │
       │◀──────────────────────────────────────────│   Web App    │
       │                                           │              │
       │ 7. Receive session token                  │  (Complete   │
       │◀──────────────────────────────────────────│   session)   │
       │                                           │              │
       │ 8. Store token in .kyoto/config.json      └──────────────┘
       │
       ▼
┌─────────────┐
│             │
│ Authenticated│
│             │
└─────────────┘
```

## State Management

### State Token
- Generated by CLI using `crypto.randomBytes(32).toString('hex')`
- 64 hexadecimal characters
- Used to correlate the CLI session with the OAuth callback

### Session States
1. **pending** - Waiting for OAuth completion
2. **completed** - OAuth successful, token available
3. **failed** - OAuth or validation failed

### Security Considerations

1. **State Token Validation**
   - Must be exactly 64 hex characters
   - Validated on both client and server
   - Single-use (deleted after retrieval)

2. **Session Expiration**
   - 5-minute timeout
   - Automatic cleanup of expired sessions
   - Prevents indefinite memory growth

3. **Better-Auth State Management**
   - Better-auth handles its own OAuth state parameter
   - Our state token is passed via `callbackURL` parameter
   - Both states are validated during the flow

## Configuration

### CLI Config Structure

The CLI stores authentication in `.kyoto/config.json`:

```json
{
  "ai": {
    "provider": "openai",
    "apiKey": "sk-...",
    "model": "gpt-4"
  },
  "auth": {
    "sessionToken": "...",
    "user": {
      "name": "John Doe",
      "login": "johndoe"
    }
  }
}
```

### Environment Variables

The CLI respects the following environment variable:
- `APP_URL` - The web application URL (default: `http://localhost:3002`)

## Usage

```bash
# Login via GitHub OAuth
kyoto login

# The command will:
# 1. Open your browser
# 2. Prompt you to authenticate with GitHub
# 3. Store the session token
# 4. Return to the CLI with success message
```

## Testing

### Local Development

1. Start the web app:
   ```bash
   bun run dev:web
   ```

2. Run the CLI login command:
   ```bash
   kyoto login
   ```

3. Complete the GitHub OAuth flow in the browser

4. Verify the session token is stored:
   ```bash
   cat .kyoto/config.json
   ```

### Testing Notes

- The in-memory store resets when the web app restarts
- Sessions expire after 5 minutes
- Maximum one session per state token
- The state token is single-use

## Better-Auth Integration

### Traps and Considerations

1. **Callback URL Management**
   - Better-auth expects the `callbackURL` in `signIn.social()`
   - We pass our state via query parameter in the callback URL
   - Format: `/cli/callback?state=<token>`

2. **Session Token Retrieval**
   - Use `auth.api.getSession()` server-side
   - Session includes both user and session.token
   - Token is what we store for CLI authentication

3. **Redirect Handling**
   - Better-auth handles OAuth redirects automatically
   - We redirect to success/error pages after completion
   - Use Next.js `redirect()` for proper handling

4. **State Parameter Conflict**
   - Better-auth uses its own `state` for OAuth security
   - Our CLI state is separate and passed via callback URL
   - Both are validated independently

## Future Improvements

1. **Persistent Storage**
   - Currently uses in-memory Map
   - Could migrate to Redis or database for production
   - Would enable multi-instance deployments

2. **Token Refresh**
   - Implement automatic token refresh
   - Add expiration tracking
   - Handle expired token errors

3. **Multiple Sessions**
   - Support multiple CLI sessions per user
   - Session management commands
   - Session revocation

4. **Security Enhancements**
   - Rate limiting on polling endpoint
   - CSRF tokens
   - IP address validation
   - User-agent validation

## Troubleshooting

### Common Issues

1. **Session not found**
   - The 5-minute timeout may have expired
   - Run `kyoto login` again

2. **OAuth fails**
   - Ensure GitHub OAuth app is configured
   - Check `GITHUB_CLIENT_ID` and `GITHUB_CLIENT_SECRET`
   - Verify callback URL is registered

3. **Browser doesn't open**
   - Manually navigate to the URL shown in the terminal
   - Check platform-specific open commands

4. **Token not stored**
   - Ensure `.kyoto` directory exists
   - Check file permissions
   - Verify git root is found
