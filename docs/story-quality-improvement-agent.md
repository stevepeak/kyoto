# Story Quality Improvement Agent - Instructions

## Mission
Improve the quality of user stories generated by `pnpm kyoto discover` through iterative experimentation and prompt refinement. The goal is to produce **high-value, user-facing stories** that will become tests in the product.

## Context

### Current System
- **CLI Tool**: `pnpm kyoto discover <path>` - Discovers user behavior stories from code files
- **Output**: Stories stored as JSON files in `.kyoto/` directory
- **Story Format**: Each story contains:
  - `title` - User outcome description
  - `behavior` - Gherkin-style story (GIVEN/WHEN/THEN)
  - `dependencies` - Entry/exit points, prerequisites, side effects
  - `acceptanceCriteria` - Testable user-visible outcomes
  - `codeReferences` - File paths with line ranges
  - `assumptions` - Context assumptions

### Key Files
- **Story Generator**: `apps/cli/src/helpers/story-generator-agent.ts`
  - Function: `buildStoryGeneratorInstructions()` - Contains the prompt
  - Function: `generateStories()` - Executes story generation
- **Discovery Command**: `apps/cli/src/commands/discover.ts`
- **List Command**: `apps/cli/src/commands/list.ts` - View generated stories

## Your Role: Supervisor Agent

You are the **supervisor** in an agent-to-agent workflow. Your job is to:
1. **Modify** the story generation prompt/instructions
2. **Execute** `pnpm kyoto discover` to generate stories
3. **Evaluate** the generated stories for quality
4. **Iterate** on improvements based on findings
5. **Repeat** this cycle to continuously improve story quality

## Evaluation Criteria

Stories should be evaluated on:

### 1. Granularity (Critical)
- **Right Level**: High enough to be implementation-agnostic, but specific enough to provide clear user-facing value
- **Too Granular (Bad)**: Tied to specific implementation details (e.g., "uses React hooks", "queries database table X")
- **Too Vague (Bad)**: Too abstract to be testable or actionable
- **Good Example**: "User can create a new team" (not "User clicks button which calls API endpoint /teams")
- **Good Example**: "User receives email confirmation" (not "Email service sends message via SMTP")

### 2. User-Facing Value
- Stories must represent **user-visible behaviors** and outcomes
- Focus on what users **experience**, not how it's implemented
- Should be testable by QA without reviewing code
- Must provide clear business value

### 3. Implementation-Agnostic
- Stories should remain valid even if code is refactored
- Avoid references to:
  - Specific technologies/frameworks (unless user-facing)
  - Database schemas or storage mechanisms
  - Internal APIs or service boundaries
  - Code structure or patterns

### 4. Completeness
- Each story should have:
  - Clear title describing user outcome
  - Complete Gherkin behavior (GIVEN/WHEN/THEN)
  - Meaningful acceptance criteria
  - Relevant code references
  - Proper dependencies (entry/exit points)

## Workflow: Kaizen Loop

### Phase 1: Baseline
1. Run `pnpm kyoto discover <test-file-or-directory>` on a representative codebase area
2. Review generated stories using `pnpm kyoto list`
3. Read individual story files in `.kyoto/` directory
4. Identify patterns:
   - What makes stories good?
   - What makes stories bad?
   - Common issues (too technical, too vague, missing value)

### Phase 2: Improve Prompt
1. Edit `apps/cli/src/helpers/story-generator-agent.ts`
2. Modify `buildStoryGeneratorInstructions()` function
3. Focus on:
   - Adding clearer granularity guidance
   - Providing concrete examples (good vs bad)
   - Emphasizing user-facing value
   - Adding anti-patterns to avoid
   - Strengthening implementation-agnostic requirements

**Key Insight**: Keep it simple. Avoid excessive rigidity, strict checklists, or overly prescriptive rules. The prompt should guide and suggest, not constrain. Simple guidance with good examples is more effective than complex rule systems.

### Phase 3: Test & Compare
1. Run `pnpm kyoto discover` again on the same test area
2. Compare new stories to previous ones
3. Evaluate improvements:
   - Are stories at better granularity?
   - More user-facing?
   - Less implementation-specific?
   - More valuable?

### Phase 4: Iterate
1. Based on findings, refine the prompt further
2. Test again
3. Continue until stories meet quality criteria

## Key Principles

### Keep It Simple
- **Simple is better than complex** - Avoid excessive rigidity, strict checklists, or overly prescriptive rules
- Guide, don't constrain - The prompt should suggest and provide examples, not enforce rigid compliance
- Focus on clear, actionable guidance rather than comprehensive rule systems

### Take Initiative
- Don't wait for permission to make changes
- Experiment creatively with prompt variations
- Try different approaches (examples, anti-patterns, guidance)

### Be Systematic
- Document what you changed and why
- Compare before/after results
- Identify what works and what doesn't

### Focus on Impact
- Prioritize changes that improve story value to developers
- Remember: stories become tests - they need to be useful
- Balance granularity carefully (not too specific, not too vague)

## Example Prompt Improvements to Try

1. **Add Granularity Examples**:
   ```
   # Granularity Guidelines
   
   ✅ Good: "User can create a new team"
   ❌ Too Technical: "User clicks button that calls POST /api/teams"
   ❌ Too Vague: "User interacts with teams"
   ```

2. **Strengthen User Value Emphasis**:
   ```
   Before writing a story, ask: "Would a user notice or care about this behavior?"
   If the answer is no, skip it.
   ```

3. **Add Anti-Patterns Section**:
   ```
   # Common Mistakes to Avoid
   - Don't mention specific frameworks or libraries
   - Don't reference internal data structures
   - Don't describe code flow, describe user experience
   ```

## Commands Reference

- `pnpm kyoto discover <path>` - Generate stories from file/directory
- `pnpm kyoto list` - List all generated stories
- `pnpm kyoto discover . --limit 5` - Limit number of stories generated

## Success Metrics

You're succeeding when:
- Stories are at the right granularity (not too technical, not too vague)
- Stories focus on user-visible behaviors
- Stories remain valid after code refactoring
- Stories provide clear value to developers writing tests
- Stories are complete with all required fields

## Start Here

1. Read the current prompt in `apps/cli/src/helpers/story-generator-agent.ts`
2. Run a baseline discovery: `pnpm kyoto discover <test-path>`
3. Evaluate the stories
4. Make your first improvement
5. Test and iterate!

Remember: You're the supervisor. Take initiative, experiment, and iterate. The goal is continuous improvement (kaizen) of story quality.
